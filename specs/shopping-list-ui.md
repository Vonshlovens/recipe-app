# Shopping List UI

> Shopping list builder, recipe selection, scaling per recipe, combined list view, check-off interaction.

---

## Overview

The shopping list UI provides the user-facing interface for building and interacting with shopping lists. The user selects recipes, adjusts servings per recipe, and views a consolidated, deduplicated shopping list generated by the server-side shopping list engine (defined in [shopping-list-engine.md](./shopping-list-engine.md)).

This spec builds on:
- [shopping-list-engine.md](./shopping-list-engine.md) — server-side ingredient parsing, scaling, aggregation, and `POST /api/v1/shopping-list`
- [api-routes.md](./api-routes.md) — `GET /api/v1/recipes` for recipe selection
- [ui-components.md](./ui-components.md) — shared UI components (ScalingControl, RecipeCard, Pagination, etc.)
- [frontend-architecture.md](./frontend-architecture.md) — routing, layout, state management

---

## Route

| Route            | Purpose                              | Auth Required |
|------------------|--------------------------------------|---------------|
| `/shopping-list` | Build and view a shopping list       | Yes           |

---

## User Flow

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  1. Select   │────▶│  2. Loading  │────▶│  3. Combined │
│  Recipes     │     │  Generation  │     │  List View   │
└──────────────┘     └──────────────┘     └──────────────┘
       │                                         │
       ▼                                         ▼
  Add/remove recipes,                     Check off items,
  adjust servings                         print, clear
```

### Step 1: Recipe Selection

The user builds a list of recipes to include in their shopping list.

#### Recipe Picker

- A search input with autocomplete queries `GET /api/v1/recipes` as the user types (debounced 300ms)
- Results appear in a dropdown showing recipe title, difficulty badge, and default servings
- Clicking a result adds it to the selected recipes list
- Max 20 recipes per shopping list (enforced client-side, matching the server limit)
- Duplicate recipes are prevented — selecting an already-added recipe shows a toast: "Recipe already added"
- Empty state: "Search for recipes to add to your shopping list"

#### Selected Recipes Panel

Each selected recipe is displayed as a compact card:

```
┌────────────────────────────────────────────────────┐
│  Crispy Chickpea Bowl                    [ × ]     │
│  Servings: [ - ]  4  [ + ]  (default: 4)          │
└────────────────────────────────────────────────────┘
```

- Recipe title with a remove button (×)
- `ScalingControl` from [ui-components.md](./ui-components.md) for adjusting servings
- Default servings label shown for reference
- Scaling limits: 1–100 servings (0.25×–10× the recipe's default, matching engine limits)
- If scaling would exceed the 0.25×–10× range, the increment/decrement buttons are disabled with a tooltip

#### Generate Button

- "Generate Shopping List" button below the selected recipes
- Disabled when no recipes are selected
- Button shows the recipe count: "Generate Shopping List (3 recipes)"
- Calls `POST /api/v1/shopping-list` with the selected recipes and servings

### Step 2: Loading / Generation

After clicking Generate, show a brief loading state:

- Spinner with message: "Building your shopping list..."
- The recipe selection panel remains visible but is disabled
- Typical response time is under 1 second, so no cancel button is needed

### Step 3: Combined List View

The generated shopping list is displayed as a checkable list grouped by ingredient.

#### List Layout

```
┌────────────────────────────────────────────────────┐
│  Shopping List (3 recipes, 24 items)      [ Print ]│
│                                           [ Clear ]│
│────────────────────────────────────────────────────│
│  ☐  3 ½ cups flour                                 │
│     └ Crispy Chickpea Bowl, Banana Bread           │
│  ☐  5 tbsp olive oil                               │
│     └ Crispy Chickpea Bowl, Pasta Aglio e Olio     │
│  ☐  1 tbsp salt                                    │
│  ☑  2 avocados ─────────── (checked / struck)      │
│  ☐  Salt and pepper to taste                       │
│     └ Crispy Chickpea Bowl                         │
│────────────────────────────────────────────────────│
│  Recipes:                                          │
│  • Crispy Chickpea Bowl (6 servings)               │
│  • Pasta Aglio e Olio (2 servings)                 │
│  • Banana Bread (8 servings)                       │
└────────────────────────────────────────────────────┘
```

#### List Items

Each shopping list item shows:
- A checkbox for check-off interaction
- Formatted quantity and unit (e.g., "3 ½ cups")
- Ingredient name
- Source recipes listed below in muted text (collapsed by default on mobile, shown on hover/tap)

#### Check-Off Interaction

- Clicking a checkbox toggles the item's checked state
- Checked items receive `line-through` and `opacity-50` styling
- Checked items move to the bottom of the list (unchecked items stay sorted by name)
- Check state is stored in local component state (not persisted to server)
- A "checked count" is shown: "8 of 24 items checked"
- An "Uncheck All" button resets all items to unchecked

#### Source Recipe References

- Below the list, a "Recipes" section shows each source recipe with its scaled servings
- Each recipe title links to `/recipes/{slug}` for quick reference

---

## Actions

### Print

- A "Print" button generates a print-friendly view of the shopping list
- Print view includes:
  - List title with date
  - All items with quantities (unchecked items only, or all items with checkboxes)
  - Source recipes section
- Uses `@media print` CSS rules: hide Navbar, Footer, action buttons, checked items
- Triggered via `window.print()`

### Clear

- A "Clear" button resets the shopping list and returns to the recipe selection step
- If items have been checked, show a `ConfirmDialog`: "Clear shopping list? Your checked items will be lost."
- Clears all selected recipes and check state

### Edit Recipes

- A "Edit Recipes" button (or collapsible panel) allows modifying the recipe selection and servings after the list is generated
- Changes trigger a re-generation of the shopping list via a new API call
- Check state is reset when the list is regenerated (since items may change)

---

## Page Layout

### Desktop (>= 1024px)

Two-column layout:

```
┌────────────────────────────────────────────────────────────────┐
│  Shopping List                                                  │
│                                                                 │
│  ┌─────────────────────┐  ┌──────────────────────────────────┐ │
│  │  Recipe Selection    │  │  Shopping List                   │ │
│  │  (320px sidebar)     │  │  (fluid main area)              │ │
│  │                      │  │                                  │ │
│  │  [Search recipes...] │  │  ☐ 3 ½ cups flour               │ │
│  │                      │  │  ☐ 5 tbsp olive oil             │ │
│  │  Selected:           │  │  ☐ 1 tbsp salt                  │ │
│  │  ┌────────────────┐  │  │  ...                            │ │
│  │  │ Chickpea Bowl  │  │  │                                  │ │
│  │  │ Servings: 6    │  │  │  Recipes:                       │ │
│  │  └────────────────┘  │  │  • Chickpea Bowl (6 servings)   │ │
│  │                      │  │  • Pasta (2 servings)           │ │
│  │  [Generate List (1)] │  │                                  │ │
│  └─────────────────────┘  └──────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────┘
```

- Recipe selection in a fixed-width left sidebar (320px)
- Shopping list in the fluid right area
- Sidebar scrolls independently
- After generating, sidebar collapses to a summary with "Edit Recipes" toggle

### Tablet (768px–1023px)

- Recipe selection and shopping list stack vertically
- Recipe selection collapses to a summary bar after generation
- Shopping list uses full width

### Mobile (< 768px)

- Full-width single column
- Recipe selection is a collapsible section that collapses after generation
- Shopping list items use larger touch targets (min 44px height)
- Source recipes shown on tap (not hover)
- Simplified pagination in recipe search dropdown

---

## State Management

The shopping list page uses local component state (runes):

```typescript
type ShoppingListStep = "select" | "loading" | "list";

let step: ShoppingListStep = $state("select");
let selectedRecipes: SelectedRecipe[] = $state([]);
let shoppingList: ShoppingList | null = $state(null);
let checkedItems: Set<number> = $state(new Set());
let searchQuery: string = $state("");
let searchResults: RecipeSummary[] = $state([]);
```

```typescript
interface SelectedRecipe {
  recipeId: string;
  title: string;
  slug: string;
  defaultServings: number;
  targetServings: number;
}
```

- `step` drives which UI is rendered
- `selectedRecipes` tracks chosen recipes with their scaling
- `shoppingList` holds the API response
- `checkedItems` tracks checked item indices (local only)
- `searchQuery` and `searchResults` manage the recipe picker

---

## Implementation Location

```
src/routes/shopping-list/
  +page.server.ts              # Auth guard (redirect to /auth/login if not authenticated)
  +page.svelte                 # Shopping list page (select, loading, list)
src/lib/components/shopping-list/
  RecipePicker.svelte          # Search input with autocomplete dropdown
  SelectedRecipeCard.svelte    # Compact card with scaling control and remove button
  ShoppingListView.svelte      # Combined list with checkboxes and source references
  ShoppingListItem.svelte      # Single item row with checkbox, quantity, name, sources
  RecipeSummaryBar.svelte      # Collapsed recipe selection summary after generation
```

---

## Error Handling

| Scenario                        | Behavior                                                                                  |
|---------------------------------|-------------------------------------------------------------------------------------------|
| `EMPTY_SHOPPING_LIST`           | Prevented client-side — Generate button is disabled when no recipes selected               |
| `TOO_MANY_RECIPES`             | Prevented client-side — recipe picker disabled after 20 selections                         |
| `RECIPE_NOT_FOUND`             | Show error toast: "One or more recipes could not be found. They may have been deleted."    |
| `INVALID_SERVINGS`             | Prevented client-side — ScalingControl enforces valid range                                 |
| `SCALING_OUT_OF_RANGE`         | Prevented client-side — ScalingControl disables buttons at limits                           |
| `DUPLICATE_RECIPE`             | Prevented client-side — duplicate selection blocked with toast                              |
| Network error                   | Show error toast with "Retry" button that re-sends the same request                        |
| Server error (500)              | Show ErrorBanner: "Something went wrong generating your shopping list. Please try again."  |

All server errors follow the standard error envelope from [backend-architecture.md](./backend-architecture.md).

---

## Accessibility

- Recipe search input has a visible label: "Search recipes"
- Search results dropdown uses `role="listbox"` with `role="option"` items and keyboard navigation (arrow keys, Enter to select)
- Selected recipe cards are a `role="list"` with descriptive labels
- Shopping list items use native `<input type="checkbox">` with associated `<label>` elements
- Checked count announced via `aria-live="polite"` region
- Loading state announces "Building shopping list" to screen readers via `aria-live="polite"`
- Print button labeled "Print shopping list"
- Clear button triggers confirmation dialog with focus trap
- All interactive elements follow keyboard patterns from [ui-components.md](./ui-components.md)

---

## Performance Considerations

- Recipe search is debounced at 300ms to avoid excessive API calls
- Shopping list generation is a single API request — no polling needed
- Check-off state is local component state, no server round-trips
- The shopping list view renders a flat list (max ~600 items with 20 recipes), no virtualization needed
- Recipe search results are limited to 10 items per query to keep the dropdown lightweight
